<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחשבון דגימה מתקדם MIL-STD-105E</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; }
        .lucide { width: 1em; height: 1em; vertical-align: middle; display: inline-block; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // יצירת רכיב אייקון מותאם כדי שיעבוד ב-React
        const Icon = ({ name, className = "" }) => {
            React.useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const LOT_SIZE_RANGES = [
          { min: 2, max: 8, codes: { S1: 'A', S2: 'A', S3: 'A', S4: 'A', I: 'A', II: 'A', III: 'B' } },
          { min: 9, max: 15, codes: { S1: 'A', S2: 'A', S3: 'A', S4: 'A', I: 'A', II: 'B', III: 'C' } },
          { min: 16, max: 25, codes: { S1: 'A', S2: 'A', S3: 'B', S4: 'B', I: 'B', II: 'C', III: 'D' } },
          { min: 26, max: 50, codes: { S1: 'A', S2: 'B', S3: 'B', S4: 'C', I: 'C', II: 'D', III: 'E' } },
          { min: 51, max: 90, codes: { S1: 'B', S2: 'B', S3: 'C', S4: 'D', I: 'C', II: 'E', III: 'F' } },
          { min: 91, max: 150, codes: { S1: 'B', S2: 'B', S3: 'C', S4: 'D', I: 'D', II: 'F', III: 'G' } },
          { min: 151, max: 280, codes: { S1: 'B', S2: 'C', S3: 'D', S4: 'E', I: 'E', II: 'G', III: 'H' } },
          { min: 281, max: 500, codes: { S1: 'B', S2: 'C', S3: 'D', S4: 'E', I: 'F', II: 'H', III: 'J' } },
          { min: 501, max: 1200, codes: { S1: 'C', S2: 'C', S3: 'E', S4: 'F', I: 'G', II: 'J', III: 'K' } },
          { min: 1201, max: 3200, codes: { S1: 'C', S2: 'D', S3: 'E', S4: 'G', I: 'H', II: 'K', III: 'L' } },
          { min: 3201, max: 10000, codes: { S1: 'C', S2: 'D', S3: 'F', S4: 'G', I: 'J', II: 'L', III: 'M' } },
          { min: 10001, max: 35000, codes: { S1: 'C', S2: 'D', S3: 'F', S4: 'H', I: 'K', II: 'M', III: 'N' } },
          { min: 35001, max: 150000, codes: { S1: 'D', S2: 'E', S3: 'G', S4: 'J', I: 'L', II: 'N', III: 'P' } },
          { min: 151001, max: 500000, codes: { S1: 'D', S2: 'E', S3: 'G', S4: 'J', I: 'M', II: 'P', III: 'Q' } },
          { min: 500001, max: Infinity, codes: { S1: 'D', S2: 'E', S3: 'H', S4: 'K', I: 'N', II: 'Q', III: 'R' } },
        ];

        const ORDERED_CODES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R'];
        const AQL_VALUES = [0.010, 0.015, 0.025, 0.040, 0.065, 0.10, 0.15, 0.25, 0.40, 0.65, 1.0, 1.5, 2.5, 4.0, 6.5, 10, 15];
        const SIZES_SINGLE = { 'A': 2, 'B': 3, 'C': 5, 'D': 8, 'E': 13, 'F': 20, 'G': 32, 'H': 50, 'J': 80, 'K': 125, 'L': 200, 'M': 315, 'N': 500, 'P': 800, 'Q': 1250, 'R': 2000 };

        const getTableData = (planType, code, aql) => {
          const codeIdx = ORDERED_CODES.indexOf(code);
          const aqlIdx = AQL_VALUES.indexOf(aql);
          if (aqlIdx < (10 - codeIdx) / 2.5) return 'D';
          if (aqlIdx > (22 - codeIdx) / 1.5) return 'U';
          let ac = Math.max(0, Math.floor((codeIdx + aqlIdx - 10) / 1.2));
          let re = ac + 1;
          let sampleSize = SIZES_SINGLE[code];
          if (planType === 'single') return { type: 'single', steps: [[sampleSize, ac, re]] };
          if (planType === 'double') {
            const s = Math.ceil(sampleSize * 0.625);
            return { type: 'double', steps: [[s, ac, ac + 2], [s, ac + 2, ac + 3]] };
          }
          if (planType === 'multiple') {
            const s = Math.ceil(sampleSize * 0.25);
            return { type: 'multiple', steps: [[s, -1, 2], [s, -1, 2], [s, 0, 2], [s, ac, ac + 2], [s, ac + 1, ac + 3], [s, ac + 2, ac + 4], [s, ac + 3, ac + 4]] };
          }
          return null;
        };

        function App() {
          const [lotSize, setLotSize] = React.useState('');
          const [category, setCategory] = React.useState('general');
          const [level, setLevel] = React.useState('II');
          const [planType, setPlanType] = React.useState('single');
          const [aql, setAql] = React.useState(2.5);

          const isLotSizeValid = lotSize !== '' && parseInt(lotSize) >= 2;

          const result = React.useMemo(() => {
            if (!isLotSizeValid) return null;
            const range = LOT_SIZE_RANGES.find(r => lotSize >= r.min && lotSize <= r.max);
            const codeKey = level.replace('-', ''); 
            const originalCode = range ? range.codes[codeKey] : 'A';
            let currentCode = originalCode;
            let planData = null;
            let arrowPath = [];
            let attempts = 0;

            while (attempts < 15) {
              let data = getTableData(planType, currentCode, aql);
              if (typeof data === 'object' && data !== null) { planData = data; break; }
              else if (data === 'D') {
                let idx = ORDERED_CODES.indexOf(currentCode);
                if (idx < ORDERED_CODES.length - 1) { currentCode = ORDERED_CODES[idx + 1]; arrowPath.push('↓'); }
                else break;
              } else if (data === 'U') {
                let idx = ORDERED_CODES.indexOf(currentCode);
                if (idx > 0) { currentCode = ORDERED_CODES[idx - 1]; arrowPath.push('↑'); }
                else break;
              }
              attempts++;
            }

            let steps = [];
            if (planData) {
              let cum = 0;
              planData.steps.forEach((s, i) => {
                const [size, ac, re] = s;
                cum += size;
                steps.push({ step: i + 1, size, cum, ac: ac === -1 ? '#' : ac, re });
              });
            }
            return { originalCode, finalCode: currentCode, arrowPath: arrowPath.join(' '), steps };
          }, [lotSize, level, planType, aql, isLotSizeValid]);

          return (
            <div className="min-h-screen bg-slate-100 p-2 md:p-4 text-right" dir="rtl">
              <div className="max-w-6xl mx-auto bg-white rounded-2xl md:rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
                
                {/* Header */}
                <div className="bg-slate-900 text-white p-5 md:p-8 flex flex-col md:flex-row items-center justify-between gap-4">
                  <div>
                    <h1 className="text-xl md:text-3xl font-black flex items-center gap-3">
                      <Icon name="clipboard-check" className="text-blue-400 w-8 h-8" />
                      <span>מחשבון דגימה מתקדם</span>
                    </h1>
                    <p className="text-slate-400 mt-1 italic text-xs md:text-sm">MIL-STD-105E Sampling Calculator</p>
                  </div>
                </div>

                <div className="grid lg:grid-cols-12 gap-0">
                  {/* Sidebar Controls */}
                  <div className="lg:col-span-4 p-4 md:p-6 bg-slate-50 border-l border-slate-200 space-y-6">
                    <div>
                      <label className="block text-xs font-black text-slate-500 mb-2 uppercase tracking-widest">גודל מנה (N)</label>
                      <input type="number" value={lotSize} onChange={(e) => setLotSize(e.target.value === '' ? '' : parseInt(e.target.value))} className="w-full p-4 bg-white border-2 border-slate-200 rounded-2xl focus:border-blue-500 outline-none font-black text-2xl text-center transition-all" />
                    </div>

                    <div className={!isLotSizeValid ? 'opacity-30 pointer-events-none' : ''}>
                      <label className="block text-xs font-black text-slate-500 mb-2 uppercase">סוג בחינה</label>
                      <div className="flex bg-slate-200 p-1 rounded-xl">
                        <button onClick={() => {setCategory('general'); setLevel('II')}} className={`flex-1 py-2 rounded-lg font-bold text-sm ${category === 'general' ? 'bg-white text-blue-700 shadow-sm' : 'text-slate-500'}`}>כללית</button>
                        <button onClick={() => {setCategory('special'); setLevel('S-4')}} className={`flex-1 py-2 rounded-lg font-bold text-sm ${category === 'special' ? 'bg-white text-amber-700 shadow-sm' : 'text-slate-500'}`}>מיוחדת</button>
                      </div>
                    </div>

                    <div className={!isLotSizeValid ? 'opacity-30 pointer-events-none' : ''}>
                      <label className="block text-xs font-black text-slate-500 mb-2 uppercase">רמת בחינה</label>
                      <div className="grid grid-cols-3 gap-2">
                        {(category === 'general' ? ['I', 'II', 'III'] : ['S-1', 'S-2', 'S-3', 'S-4']).map(lvl => (
                          <button key={lvl} onClick={() => setLevel(lvl)} className={`py-2 rounded-lg text-xs font-black border-2 transition-all ${level === lvl ? 'bg-slate-800 border-slate-800 text-white' : 'bg-white border-slate-200 text-slate-500'}`}>{lvl}</button>
                        ))}
                      </div>
                    </div>

                    <div className={`grid grid-cols-2 gap-3 ${!isLotSizeValid ? 'opacity-30 pointer-events-none' : ''}`}>
                      <select value={planType} onChange={(e) => setPlanType(e.target.value)} className="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-sm">
                        <option value="single">בודדת</option>
                        <option value="double">כפולה</option>
                        <option value="multiple">מרובה</option>
                      </select>
                      <select value={aql} onChange={(e) => setAql(parseFloat(e.target.value))} className="w-full p-3 bg-white border-2 border-slate-200 rounded-xl font-bold text-sm">
                        {AQL_VALUES.map(v => <option key={v} value={v}>{v}%</option>)}
                      </select>
                    </div>
                  </div>

                  {/* Results Panel */}
                  <div className="lg:col-span-8 p-4 md:p-8">
                    {!isLotSizeValid ? (
                      <div className="h-full flex flex-col items-center justify-center text-center p-12 bg-slate-50 rounded-3xl border-4 border-dashed border-slate-100 text-slate-400">
                        <Icon name="arrow-down" className="w-12 h-12 mb-4 animate-bounce" />
                        <h3 className="text-xl font-black">הזן גודל מנה לחישוב</h3>
                      </div>
                    ) : (
                      <div className="space-y-8 animate-in fade-in duration-500">
                        <div className="p-8 rounded-[2.5rem] shadow-2xl flex flex-col md:flex-row justify-between items-center bg-slate-900 text-white gap-8">
                          <div className="text-center md:text-right">
                            <span className="text-[10px] font-black opacity-50 block mb-2 uppercase tracking-widest">אות קוד</span>
                            <div className="flex items-center gap-4">
                              <span className="text-8xl font-black tracking-tighter">{result.originalCode}</span>
                              {result.arrowPath && (
                                <div className="flex items-center gap-3 bg-white/10 px-6 py-4 rounded-[2rem] border border-white/20">
                                  <span className="text-3xl animate-pulse">{result.arrowPath}</span>
                                  <span className="text-5xl font-black">{result.finalCode}</span>
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="grid grid-cols-3 gap-8 border-r-2 border-white/10 pr-8">
                            <div><span className="block text-[10px] opacity-50 uppercase">בחינה</span><span className="text-xl font-bold">{category === 'general' ? 'כללית' : 'מיוחדת'}</span></div>
                            <div><span className="block text-[10px] opacity-50 uppercase">רמה</span><span className="text-xl font-bold">{level}</span></div>
                            <div><span className="block text-[10px] opacity-50 uppercase">AQL</span><span className="text-xl font-bold">{aql}%</span></div>
                          </div>
                        </div>

                        <div className="bg-white border border-slate-200 rounded-[2rem] shadow-sm overflow-hidden">
                          <div className="bg-slate-100 px-8 py-5 font-black text-slate-800 flex items-center gap-2 border-b">
                            <Icon name="layers" className="w-5 h-5 text-blue-500" />
                            תוכנית דגימה {planType}
                          </div>
                          <table className="w-full text-center">
                            <thead>
                              <tr className="text-slate-400 text-xs font-black uppercase border-b">
                                <th className="p-6">שלב</th>
                                <th className="p-6">מדגם (n)</th>
                                <th className="p-6">מצטבר</th>
                                <th className="p-6 bg-emerald-50 text-emerald-700">Ac</th>
                                <th className="p-6 bg-rose-50 text-rose-700">Re</th>
                              </tr>
                            </thead>
                            <tbody>
                              {result.steps.map((s, i) => (
                                <tr key={i} className="border-b last:border-0 hover:bg-slate-50 transition-all">
                                  <td className="p-6 text-slate-300 font-bold italic">{s.step}</td>
                                  <td className="p-6 font-black text-slate-800 text-3xl">{s.size}</td>
                                  <td className="p-6 text-slate-400 font-bold">{s.cum}</td>
                                  <td className="p-6 bg-emerald-50 font-black text-emerald-600 text-4xl">{s.ac}</td>
                                  <td className="p-6 bg-rose-50 font-black text-rose-600 text-4xl">{s.re}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
