<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מחשבון דגימה MIL-STD-105E</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; margin: 0; }
        .mobile-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        input { font-size: 16px !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const Icon = ({ name, className = "" }) => {
            React.useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={`${className} inline-block`}></i>;
        };

        const LOT_SIZE_RANGES = [
          { min: 2, max: 8, codes: { S1: 'A', S2: 'A', S3: 'A', S4: 'A', I: 'A', II: 'A', III: 'B' } },
          { min: 9, max: 15, codes: { S1: 'A', S2: 'A', S3: 'A', S4: 'A', I: 'A', II: 'B', III: 'C' } },
          { min: 16, max: 25, codes: { S1: 'A', S2: 'A', S3: 'B', S4: 'B', I: 'B', II: 'C', III: 'D' } },
          { min: 26, max: 50, codes: { S1: 'A', S2: 'B', S3: 'B', S4: 'C', I: 'C', II: 'D', III: 'E' } },
          { min: 51, max: 90, codes: { S1: 'B', S2: 'B', S3: 'C', S4: 'D', I: 'C', II: 'E', III: 'F' } },
          { min: 91, max: 150, codes: { S1: 'B', S2: 'B', S3: 'C', S4: 'D', I: 'D', II: 'F', III: 'G' } },
          { min: 151, max: 280, codes: { S1: 'B', S2: 'C', S3: 'D', S4: 'E', I: 'E', II: 'G', III: 'H' } },
          { min: 281, max: 500, codes: { S1: 'B', S2: 'C', S3: 'D', S4: 'E', I: 'F', II: 'H', III: 'J' } },
          { min: 501, max: 1200, codes: { S1: 'C', S2: 'C', S3: 'E', S4: 'F', I: 'G', II: 'J', III: 'K' } },
          { min: 1201, max: 3200, codes: { S1: 'C', S2: 'D', S3: 'E', S4: 'G', I: 'H', II: 'K', III: 'L' } },
          { min: 3201, max: 10000, codes: { S1: 'C', S2: 'D', S3: 'F', S4: 'G', I: 'J', II: 'L', III: 'M' } },
          { min: 10001, max: 35000, codes: { S1: 'C', S2: 'D', S3: 'F', S4: 'H', I: 'K', II: 'M', III: 'N' } },
          { min: 35001, max: 150000, codes: { S1: 'D', S2: 'E', S3: 'G', S4: 'J', I: 'L', II: 'N', III: 'P' } },
          { min: 151001, max: 500000, codes: { S1: 'D', S2: 'E', S3: 'G', S4: 'J', I: 'M', II: 'P', III: 'Q' } },
          { min: 500001, max: Infinity, codes: { S1: 'D', S2: 'E', S3: 'H', S4: 'K', I: 'N', II: 'Q', III: 'R' } },
        ];

        const ORDERED_CODES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R'];
        const AQL_VALUES = [0.010, 0.015, 0.025, 0.040, 0.065, 0.10, 0.15, 0.25, 0.40, 0.65, 1.0, 1.5, 2.5, 4.0, 6.5, 10, 15];
        const SIZES_SINGLE = { 'A': 2, 'B': 3, 'C': 5, 'D': 8, 'E': 13, 'F': 20, 'G': 32, 'H': 50, 'J': 80, 'K': 125, 'L': 200, 'M': 315, 'N': 500, 'P': 800, 'Q': 1250, 'R': 2000 };

        const getTableData = (planType, code, aql) => {
          const codeIdx = ORDERED_CODES.indexOf(code);
          const aqlIdx = AQL_VALUES.indexOf(aql);
          if (aqlIdx < (10 - codeIdx) / 2.5) return 'D';
          if (aqlIdx > (22 - codeIdx) / 1.5) return 'U';
          let ac = Math.max(0, Math.floor((codeIdx + aqlIdx - 10) / 1.2));
          let re = ac + 1;
          let sampleSize = SIZES_SINGLE[code];
          if (planType === 'single') return { type: 'single', steps: [[sampleSize, ac, re]] };
          if (planType === 'double') {
            const s = Math.ceil(sampleSize * 0.625);
            return { type: 'double', steps: [[s, ac, ac + 2], [s, ac + 2, ac + 3]] };
          }
          if (planType === 'multiple') {
            const s = Math.ceil(sampleSize * 0.25);
            return { type: 'multiple', steps: [[s, -1, 2], [s, -1, 2], [s, 0, 2], [s, ac, ac + 2], [s, ac + 1, ac + 3], [s, ac + 2, ac + 4], [s, ac + 3, ac + 4]] };
          }
          return null;
        };

        function App() {
          const [lotSizeInput, setLotSizeInput] = React.useState('');
          const [category, setCategory] = React.useState('general');
          const [level, setLevel] = React.useState('II');
          const [planType, setPlanType] = React.useState('single');
          const [aql, setAql] = React.useState(2.5);

          const lotSize = parseInt(lotSizeInput);
          const isLotSizeValid = !isNaN(lotSize) && lotSize >= 2;

          const result = React.useMemo(() => {
            if (!isLotSizeValid) return null;
            try {
                const range = LOT_SIZE_RANGES.find(r => lotSize >= r.min && lotSize <= r.max);
                const codeKey = level.replace('-', ''); 
                const originalCode = range ? range.codes[codeKey] : 'A';
                let currentCode = originalCode;
                let planData = null;
                let arrowPath = [];
                let attempts = 0;

                while (attempts < 15) {
                  let data = getTableData(planType, currentCode, aql);
                  if (typeof data === 'object' && data !== null) { planData = data; break; }
                  else if (data === 'D') {
                    let idx = ORDERED_CODES.indexOf(currentCode);
                    if (idx < ORDERED_CODES.length - 1) { currentCode = ORDERED_CODES[idx + 1]; arrowPath.push('↓'); }
                    else break;
                  } else if (data === 'U') {
                    let idx = ORDERED_CODES.indexOf(currentCode);
                    if (idx > 0) { currentCode = ORDERED_CODES[idx - 1]; arrowPath.push('↑'); }
                    else break;
                  }
                  attempts++;
                }

                let steps = [];
                if (planData) {
                  let cum = 0;
                  planData.steps.forEach((s, i) => {
                    const [size, ac, re] = s;
                    cum += size;
                    steps.push({ step: i + 1, size, cum, ac: ac === -1 ? '#' : ac, re });
                  });
                }
                return { originalCode, finalCode: currentCode, arrowPath: arrowPath.join(' '), steps };
            } catch(e) { return null; }
          }, [lotSize, level, planType, aql, isLotSizeValid]);

          return (
            <div className="min-h-screen pb-10">
              <div className="bg-slate-900 text-white p-4 md:p-6 shadow-lg">
                 <div className="max-w-6xl mx-auto flex items-center gap-3">
                    <Icon name="clipboard-check" className="text-blue-400 w-6 h-6" />
                    <h1 className="text-xl font-black">מחשבון דגימה מתקדם</h1>
                 </div>
              </div>

              <div className="max-w-6xl mx-auto p-4 md:p-6 grid lg:grid-cols-12 gap-6">
                <div className="lg:col-span-4 space-y-4 bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                  <div>
                    <label className="block text-xs font-black text-slate-500 mb-2 uppercase">גודל מנה (N)</label>
                    <input 
                      type="number" 
                      inputMode="numeric"
                      value={lotSizeInput} 
                      onChange={(e) => setLotSizeInput(e.target.value)} 
                      className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none font-black text-2xl text-center" 
                      placeholder="הזן מספר..."
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => {setCategory('general'); setLevel('II')}} className={`py-3 rounded-xl font-bold text-xs border-2 transition-all ${category === 'general' ? 'bg-blue-700 border-blue-700 text-white shadow-md' : 'bg-white border-slate-100 text-slate-400'}`}>כללית</button>
                    <button onClick={() => {setCategory('special'); setLevel('S-4')}} className={`py-3 rounded-xl font-bold text-xs border-2 transition-all ${category === 'special' ? 'bg-amber-600 border-amber-600 text-white shadow-md' : 'bg-white border-slate-100 text-slate-400'}`}>מיוחדת</button>
                  </div>

                  <div className="grid grid-cols-4 gap-2">
                    {(category === 'general' ? ['I', 'II', 'III'] : ['S-1', 'S-2', 'S-3', 'S-4']).map(lvl => (
                      <button key={lvl} onClick={() => setLevel(lvl)} className={`py-2 rounded-lg text-xs font-black border-2 transition-all ${level === lvl ? 'bg-slate-800 border-slate-800 text-white' : 'bg-white border-slate-100 text-slate-500'}`}>{lvl}</button>
                    ))}
                  </div>

                  <div className="grid grid-cols-2 gap-2 pt-2 border-t">
                    <select value={planType} onChange={(e) => setPlanType(e.target.value)} className="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none">
                      <option value="single">בודדת</option>
                      <option value="double">כפולה</option>
                      <option value="multiple">מרובה</option>
                    </select>
                    <select value={aql} onChange={(e) => setAql(parseFloat(e.target.value))} className="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none">
                      {AQL_VALUES.map(v => <option key={v} value={v}>{v}% AQL</option>)}
                    </select>
                  </div>
                </div>

                <div className="lg:col-span-8">
                  {!isLotSizeValid ? (
                    <div className="h-64 flex flex-col items-center justify-center bg-white rounded-3xl border-2 border-dashed border-slate-200 text-slate-400 space-y-3">
                      <Icon name="search" className="w-10 h-10 opacity-20" />
                      <p className="font-bold text-sm">המתנה לגודל מנה תקין (מינימום 2)</p>
                    </div>
                  ) : (
                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                      <div className="bg-slate-900 rounded-[2rem] p-6 text-white shadow-xl flex justify-between items-center">
                        <div>
                           <span className="text-[10px] font-black opacity-40 block mb-1 tracking-widest uppercase">Sampling Code</span>
                           <div className="flex items-center gap-4">
                              <span className="text-7xl font-black leading-none">{result.originalCode}</span>
                              {result.arrowPath && (
                                <div className="bg-white/10 px-4 py-2 rounded-2xl border border-white/20 flex items-center gap-3">
                                  <span className="text-xl animate-pulse text-blue-400">{result.arrowPath}</span>
                                  <span className="text-4xl font-black">{result.finalCode}</span>
                                </div>
                              )}
                           </div>
                        </div>
                        <div className="hidden sm:block opacity-20"><Icon name="database" className="w-16 h-16" /></div>
                      </div>

                      <div className="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-slate-50 px-6 py-4 border-b font-black text-xs text-slate-500 uppercase flex items-center gap-2">
                           <Icon name="table" className="w-4 h-4" /> תוכנית דגימה {planType}
                        </div>
                        <div className="mobile-scroll">
                          <table className="w-full text-center min-w-[350px]">
                            <thead>
                              <tr className="text-slate-400 text-[10px] font-black border-b bg-slate-50/30">
                                <th className="p-4 uppercase">Step</th>
                                <th className="p-4 uppercase">Sample (n)</th>
                                <th className="p-4 bg-emerald-50 text-emerald-700 uppercase">Ac</th>
                                <th className="p-4 bg-rose-50 text-rose-700 uppercase">Re</th>
                              </tr>
                            </thead>
                            <tbody>
                              {result.steps.map((s, i) => (
                                <tr key={i} className="border-b last:border-0 hover:bg-slate-50 transition-colors">
                                  <td className="p-4 text-slate-300 font-bold italic">{s.step}</td>
                                  <td className="p-4">
                                     <div className="font-black text-2xl text-slate-800 leading-tight">{s.size}</div>
                                     <div className="text-[9px] text-slate-400 font-bold">מצטבר: {s.cum}</div>
                                  </td>
                                  <td className="p-4 bg-emerald-50/30 font-black text-3xl text-emerald-600">{s.ac}</td>
                                  <td className="p-4 bg-rose-50/30 font-black text-3xl text-rose-600">{s.re}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
